name: Deploy Flora

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-southeast-2

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Enable corepack / pnpm
        run: |
          corepack enable
          pnpm install --frozen-lockfile

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          aws --version

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create production .env for frontend
        working-directory: apps/frontend
        run: |
          cat > .env <<EOF
          VITE_AUTH0_DOMAIN=${{ secrets.VITE_AUTH0_DOMAIN }}
          VITE_AUTH0_CLIENT_ID=${{ secrets.VITE_AUTH0_CLIENT_ID }}
          VITE_AUTH0_AUDIENCE=${{ secrets.VITE_AUTH0_AUDIENCE }}
          VITE_API_URL=https://dzmu16crq41il.cloudfront.net/api
          VITE_STRIPE_PUBLISHABLE_KEY=${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_APP_NAME=Flora
          VITE_APP_URL=https://dzmu16crq41il.cloudfront.net
          EOF

      - name: Make deploy script executable
        run: chmod +x scripts/deploy-frontend.sh

      - name: Deploy frontend to S3/CloudFront
        env:
          FRONTEND_BUCKET: ${{ secrets.FRONTEND_BUCKET }}
          CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: ./scripts/deploy-frontend.sh invalidate

  backend:
    runs-on: ubuntu-latest
    needs: frontend
    steps:
      - name: Checkout repo (for reference)
        uses: actions/checkout@v4

      - name: Deploy backend via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "ðŸ“‚ Navigating to project directory..."
            cd /home/ubuntu/Flora

            echo "ðŸ“¥ Pulling latest code from main..."
            git fetch origin
            git checkout main
            git reset --hard origin/main

            echo ""
            echo "ðŸ” Regenerating .env from AWS SSM Parameter Store..."

            # Function to get plain SSM parameter
            ssm_plain() {
              local name=$1
              aws ssm get-parameter \
                --name "/flora/prod/${name}" \
                --query 'Parameter.Value' \
                --output text \
                --region ap-southeast-2
            }

            # Function to get secure SSM parameter
            ssm_secure() {
              local name=$1
              aws ssm get-parameter \
                --name "/flora/prod/${name}" \
                --with-decryption \
                --query 'Parameter.Value' \
                --output text \
                --region ap-southeast-2
            }

            # Fetch all parameters from SSM
            DB_USER=$(ssm_plain "db_username")
            DB_PASSWORD=$(ssm_secure "db_password")
            AUTH0_DOMAIN=$(ssm_plain "auth0_domain")
            AUTH0_CLIENT_ID=$(ssm_plain "auth0_client_id")
            AUTH0_CLIENT_SECRET=$(ssm_secure "auth0_client_secret")
            AUTH0_AUDIENCE=$(ssm_plain "auth0_audience")
            STRIPE_SECRET_KEY=$(ssm_secure "stripe_secret_key")
            STRIPE_PUBLISHABLE_KEY=$(ssm_plain "stripe_publishable_key")
            STRIPE_WEBHOOK_SECRET=$(ssm_secure "stripe_webhook_secret")
            STRIPE_WEEKLY_PRICE_ID=$(ssm_plain "stripe_weekly_price_id")
            STRIPE_BIWEEKLY_PRICE_ID=$(ssm_plain "stripe_biweekly_price_id")
            STRIPE_MONTHLY_PRICE_ID=$(ssm_plain "stripe_monthly_price_id")
            STRIPE_SPONTANEOUS_PRICE_ID=$(ssm_plain "stripe_spontaneous_price_id")
            GMAIL_USER=$(ssm_plain "gmail_user")
            GMAIL_PASSWORD=$(ssm_secure "gmail_password")
            GEMINI_API_KEY=$(ssm_secure "gemini_api_key")
            JWT_SECRET=$(ssm_secure "jwt_secret")

            # Generate .env file
            cat > apps/backend/.env <<ENVFILE
            # Generated by GitHub Actions on $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            NODE_ENV=production
            PORT=3001

            DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${{ secrets.RDS_ENDPOINT }}:5432/flora_db

            AUTH0_DOMAIN=${AUTH0_DOMAIN}
            AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
            AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
            AUTH0_AUDIENCE=${AUTH0_AUDIENCE}

            STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
            STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
            STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
            STRIPE_WEEKLY_PRICE_ID=${STRIPE_WEEKLY_PRICE_ID}
            STRIPE_BIWEEKLY_PRICE_ID=${STRIPE_BIWEEKLY_PRICE_ID}
            STRIPE_MONTHLY_PRICE_ID=${STRIPE_MONTHLY_PRICE_ID}
            STRIPE_SPONTANEOUS_PRICE_ID=${STRIPE_SPONTANEOUS_PRICE_ID}

            GMAIL_USER=${GMAIL_USER}
            GMAIL_PASSWORD=${GMAIL_PASSWORD}
            SMTP_HOST=smtp.gmail.com
            SMTP_PORT=587
            SMTP_SECURE=false
            SMTP_USER=${GMAIL_USER}
            SMTP_PASS=${GMAIL_PASSWORD}
            FROM_EMAIL=${GMAIL_USER}
            FROM_NAME=Flora Marketplace
            CONTACT_EMAIL=${GMAIL_USER}

            GEMINI_API_KEY=${GEMINI_API_KEY}
            JWT_SECRET=${JWT_SECRET}

            FRONTEND_URL=https://dzmu16crq41il.cloudfront.net
            BACKEND_PUBLIC_URL=https://dzmu16crq41il.cloudfront.net
            EMAIL_IMAGE_BASE_URL=https://dzmu16crq41il.cloudfront.net
            EMAIL_LOGO_URL=https://dzmu16crq41il.cloudfront.net/flora-logo.png
            EMAIL_INLINE_ITEM_IMAGES=false
            ENVFILE

            echo "âœ… Generated apps/backend/.env with fresh secrets from SSM"

            echo ""
            echo "ðŸ§± Regenerating Prisma client..."
            pnpm --filter backend db:generate

            echo ""
            echo "ðŸ—ï¸  Building backend..."
            pnpm --filter backend build

            echo ""
            echo "ðŸš€ Restarting PM2 process..."
            cd apps/backend
            pm2 restart flora-backend --update-env
            pm2 save

            echo ""
            echo "ðŸ“Š Current PM2 status:"
            pm2 status

            echo ""
            echo "ðŸ“‹ Recent logs:"
            pm2 logs flora-backend --lines 15 --nostream

            echo ""
            echo "âœ… Backend deployment complete!"
